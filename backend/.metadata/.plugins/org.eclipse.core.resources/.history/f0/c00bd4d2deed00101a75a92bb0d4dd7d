package com.farmchainx.backend.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;

import com.farmchainx.backend.dto.AdminUserViewDTO;
import com.farmchainx.backend.model.*;
import com.farmchainx.backend.repository.*;

@Service
public class AdminUserService {

    private final UserRepository userRepo;
    private final FarmerRepository farmerRepo;
    private final AdminRepository adminRepo;
    private final DistributorRepository distributorRepo;
    private final RetailerRepository retailerRepo;

    public AdminUserService(UserRepository userRepo,
                            FarmerRepository farmerRepo,
                            AdminRepository adminRepo,
                            DistributorRepository distributorRepo,
                            RetailerRepository retailerRepo) {
        this.userRepo = userRepo;
        this.farmerRepo = farmerRepo;
        this.adminRepo = adminRepo;
        this.distributorRepo = distributorRepo;
        this.retailerRepo = retailerRepo;
    }

    public List<AdminUserViewDTO> getAllUsers() {

        List<User> users = userRepo.findAll();
        List<AdminUserViewDTO> result = new ArrayList<>();

        for (User u : users) {

            AdminUserViewDTO dto = new AdminUserViewDTO();
            dto.setUserId(u.getId());
            dto.setUsername(u.getUsername());
            dto.setRole(u.getRole());

            switch (u.getRole()) {

                case "FARMER":
                    Farmer f = farmerRepo.findById(u.getId()).orElse(null);
                    if (f != null) {
                        dto.setStatus(f.getStatus());
                        dto.setDetails("Farm: " + f.getFarmName());
                    }
                    break;

                case "ADMIN":
                    Admin a = adminRepo.findById(u.getId()).orElse(null);
                    if (a != null) {
                        dto.setDetails("Dept: " + a.getDepartment());
                    }
                    break;

                case "DISTRIBUTOR":
                    Distributor d = distributorRepo.findById(u.getId()).orElse(null);
                    if (d != null) {
                        dto.setDetails("Company: " + d.getCompanyName());
                    }
                    break;

                case "RETAILER":
                    Retailer r = retailerRepo.findById(u.getId()).orElse(null);
                    if (r != null) {
                        dto.setDetails("Shop: " + r.getShopName());
                    }
                    break;
            }

            result.add(dto);
        }

        return result;
    }

    public List<AdminUserViewDTO> getUsersByRole(String role) {
        return getAllUsers().stream()
                .filter(u -> u.getRole().equalsIgnoreCase(role))
                .toList();
    }
}
