package com.farmchainx.backend.service;

import java.nio.file.AccessDeniedException;
import java.util.List;

import org.springframework.stereotype.Service;

import com.farmchainx.backend.dto.AdminProfileDTO;
import com.farmchainx.backend.dto.AdminUserViewDTO;
import com.farmchainx.backend.dto.ProfileUpdateDTO;
import com.farmchainx.backend.entity.Admin;
import com.farmchainx.backend.entity.Distributor;
import com.farmchainx.backend.entity.Farmer;
import com.farmchainx.backend.entity.User;
import com.farmchainx.backend.repository.AdminRepository;
import com.farmchainx.backend.repository.FarmerRepository;
import com.farmchainx.backend.repository.UserRepository;

@Service
public class AdminService {

    private final UserRepository userRepo;
    private final FarmerRepository farmerRepo;
    private final AdminRepository adminRepo;

    public AdminService(UserRepository userRepo,
                        FarmerRepository farmerRepo,
                        AdminRepository adminRepo) {
        this.userRepo = userRepo;
        this.farmerRepo = farmerRepo;
        this.adminRepo = adminRepo;
    }

    // Profile
    public AdminProfileDTO getProfile(Long id, String username)  {
        User user = userRepo.findById(id).orElseThrow();
        if (!user.getUsername().equals(username)) {
            throw new AccessDeniedException("Not your profile");
        }
        Admin d = adminRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Admin not found"));
        AdminProfileDTO addto=new AdminProfileDTO();
        addto.setDepartment(d.getDepartment());
        return addto;
    }

    public void updateProfile(Long id, String username, ProfileUpdateDTO dto) {
        Admin a = adminRepo.findById(id).orElseThrow();
        a.setDepartment(dto.getDepartment());
        adminRepo.save(a);
    }

    // Users
    public List<AdminUserViewDTO> getAllUsers() {
        return userRepo.findAll().stream()
            .filter(u -> !u.getRole().equals("ADMIN"))
            .map(AdminUserViewDTO::fromUser)
            .toList();
    }

    public void blockUser(Long id) {
        User u = userRepo.findById(id).orElseThrow();
        u.setBlocked(true);
        userRepo.save(u);
    }

    public void unblockUser(Long id) {
        User u = userRepo.findById(id).orElseThrow();
        u.setBlocked(false);
        userRepo.save(u);
    }

    // Inbording
    public List<Farmer> getPendingFarmers() {
        return farmerRepo.findByStatus("PENDING");
    }

    public Farmer verifyFarmer(Long id) {
        return farmerRepo.findById(id).orElseThrow();
    }

    public void approveFarmer(Long id) {
        Farmer f = farmerRepo.findById(id).orElseThrow();
        f.setStatus("APPROVED");
        farmerRepo.save(f);
    }

    public void rejectFarmer(Long id) {
        Farmer f = farmerRepo.findById(id).orElseThrow();
        f.setStatus("REJECTED");
        farmerRepo.save(f);
    }
}
