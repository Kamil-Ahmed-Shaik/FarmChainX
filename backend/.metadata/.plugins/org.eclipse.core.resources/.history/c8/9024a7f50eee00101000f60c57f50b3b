package com.farmchainx.backend.service;

import java.util.List;

import org.springframework.security.access.AccessDeniedException;
import org.springframework.stereotype.Service;

import com.farmchainx.backend.dto.AdminProfileDTO;
import com.farmchainx.backend.dto.AdminUserViewDTO;
import com.farmchainx.backend.dto.ProfileUpdateDTO;
import com.farmchainx.backend.entity.Admin;
import com.farmchainx.backend.entity.Farmer;
import com.farmchainx.backend.entity.User;
import com.farmchainx.backend.repository.AdminRepository;
import com.farmchainx.backend.repository.FarmerRepository;
import com.farmchainx.backend.repository.UserRepository;

@Service
public class AdminService {

    private final UserRepository userRepo;
    private final FarmerRepository farmerRepo;
    private final AdminRepository adminRepo;

    public AdminService(UserRepository userRepo,
                        FarmerRepository farmerRepo,
                        AdminRepository adminRepo) {
        this.userRepo = userRepo;
        this.farmerRepo = farmerRepo;
        this.adminRepo = adminRepo;
    }

    // ================= ADMIN PROFILE =================

    public AdminProfileDTO getProfile(Long id, String username) {

        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        if (!user.getUsername().equals(username)) {
            throw new AccessDeniedException("Not your profile");
        }

        Admin admin = adminRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Admin not found"));

        AdminProfileDTO dto = new AdminProfileDTO();
        dto.setDepartment(admin.getDepartment());

        return dto;
    }

    public Admin updateProfile(Long id, String username, Admin dto) {

        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        if (!user.getUsername().equals(username)) {
            throw new AccessDeniedException("Not your profile");
        }

        Admin admin = adminRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Admin not found"));

        admin.setDepartment(dto.getDepartment());
        adminRepo.save(admin);

        return admin;
    }

    // ================= USER MANAGEMENT =================

    public List<AdminUserViewDTO> getAllUsers() {

        return userRepo.findAll().stream()
                .filter(u -> !u.getRole().equals("ADMIN"))
                .map(u -> {
                    AdminUserViewDTO dto = new AdminUserViewDTO();
                    dto.setUserId(u.getId());
                    dto.setUsername(u.getUsername());
                    dto.setRole(u.getRole());
                    return dto;
                })
                .toList();
    }

    public void blockUser(Long id) {
        User u = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        u.setBlocked(true);
        userRepo.save(u);
    }

    public void unblockUser(Long id) {
        User u = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        u.setBlocked(false);
        userRepo.save(u);
    }

    // ================= INBORDING =================

    public List<Farmer> getPendingFarmers() {
        return farmerRepo.findByStatus("PENDING");
    }

    public Farmer verifyFarmer(Long id) {
        return farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));
    }

    public void approveFarmer(Long id) {
        Farmer f = farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));

        f.setStatus("APPROVED");
        farmerRepo.save(f);
    }

    public void rejectFarmer(Long id) {
        Farmer f = farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));

        f.setStatus("REJECTED");
        farmerRepo.save(f);
    }
}
