package com.farmchainx.backend.service;

import java.util.List;

import org.springframework.security.access.AccessDeniedException;
import org.springframework.stereotype.Service;

import com.farmchainx.backend.dto.AdminProfileDTO;
import com.farmchainx.backend.dto.FarmerProfileDTO;
import com.farmchainx.backend.dto.ProfileUpdateDTO;
import com.farmchainx.backend.entity.Admin;
import com.farmchainx.backend.entity.Distributor;
import com.farmchainx.backend.entity.Farmer;
import com.farmchainx.backend.entity.Retailer;
import com.farmchainx.backend.entity.User;
import com.farmchainx.backend.repository.AdminRepository;
import com.farmchainx.backend.repository.DistributorRepository;
import com.farmchainx.backend.repository.FarmerRepository;
import com.farmchainx.backend.repository.RetailerRepository;
import com.farmchainx.backend.repository.UserRepository;

@Service
public class AdminService {

    private final UserRepository userRepo;
    private final FarmerRepository farmerRepo;
    private final AdminRepository adminRepo;
    private final RetailerRepository retailerRepo;
    private final DistributorRepository distributorRepo;

    public AdminService(UserRepository userRepo,
                        FarmerRepository farmerRepo,
                        AdminRepository adminRepo,
                        RetailerRepository retailerRepo,
                        DistributorRepository distributorRepo) {
        this.userRepo = userRepo;
        this.farmerRepo = farmerRepo;
        this.adminRepo = adminRepo;
        this.retailerRepo=retailerRepo;
        this.distributorRepo=distributorRepo;
    }

    // ================= ADMIN PROFILE =================

    public AdminProfileDTO getProfile(Long id, String username) {

        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        if (!user.getUsername().equals(username)) {
            throw new AccessDeniedException("Not your profile");
        }

        Admin admin = adminRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Admin not found"));

        AdminProfileDTO dto = new AdminProfileDTO();
        dto.setDepartment(admin.getDepartment());
        dto.setBlock(user.isBlocked());
        dto.setRole(user.getRole());
        dto.setUsername(user.getUsername());

        return dto;
    }

    public AdminProfileDTO updateProfile(Long id, String username, AdminProfileDTO dto) {

        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        if (!user.getUsername().equals(username)) {
            throw new AccessDeniedException("Not your profile");
        }

        Admin admin = adminRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Admin not found"));
        
        admin.setDepartment(dto.getDepartment());
        adminRepo.save(admin);
        

        return dto;
    }

    // ================= USER MANAGEMENT =================

    public List<ProfileUpdateDTO> getAllUsers() {

        return userRepo.findAll().stream()
                .filter(u -> !u.getRole().equals("ADMIN"))
                .map(u -> {
                	ProfileUpdateDTO dto = new ProfileUpdateDTO();
                    dto.setUserId(u.getId());
                    dto.setUserName(u.getUsername());
                    dto.setRole(u.getRole());
                    dto.setBlocked(u.isBlocked()) ;
                    if(u.getRole()=="DISTRIBUTOR") {
                    	Distributor d = distributorRepo.findById(u.getId())
                                .orElseThrow(() -> new RuntimeException("Distributor not found"));
                    	dto.setCompanyName(d.getCompanyName());
                    	dto.setRegion(d.getRegion());
                    	
                    }
                    else if(u.getRole()=="FARMER") {
                    	Farmer f = farmerRepo.findById(u.getId())
                                .orElseThrow(() -> new RuntimeException("Farmer not found"));
                    	dto.setAadhar(f.getAadhar());
                    	dto.setAcres(f.getAcres());
                    	dto.setCropType(f.getCropType());
                    	dto.setExpectedYield(f.getExpectedYield());
                    	dto.setFarmLocation(f.getFarmLocation());
                    	dto.setFarmName(f.getFarmName());
                    	dto.setLandPhoto(f.getLandPhoto());
                    	dto.setLatitude(f.getLatitude());
                    	dto.setLongitude(f.getLongitude());
                    	dto.setStatus(f.getStatus());
                    	dto.setMobile(f.getMobile());
                    	dto.setLocation1(f.getLocation());
                    	dto.setSoil_type(f.getSoil_type());
                    
                    }
                    else if(u.getRole()=="RETAILER") {
                    	Retailer r = retailerRepo.findById(u.getId())
                                .orElseThrow(() -> new RuntimeException("Retailer not found"));
                    	dto.setShopName(r.getShopName());
                    	dto.setLocation(r.getLocation());
                    }
                    return dto;
                })
                .toList();
    }

    public void blockUser(Long id) {
        User u = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        u.setBlocked(true);
        userRepo.save(u);
    }

    public void unblockUser(Long id) {
        User u = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        u.setBlocked(false);
        userRepo.save(u);
    }

    // ================= INBORDING =================

    public List<Farmer> getPendingFarmers() {
        return farmerRepo.findByStatus("PENDING");
    }

    public FarmerProfileDTO verifyFarmer(Long id) {
        Farmer f= farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));
        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));
        FarmerProfileDTO dto=new FarmerProfileDTO();
        dto.setUsername(user.getUsername());
        dto.setRole(user.getRole());
        dto.setFarmName(f.getFarmName());
        dto.setCropType(f.getCropType());
        dto.setLocation(f.getLocation());
        dto.setFarmLocation(f.getFarmLocation());
        dto.setMobile(f.getMobile());
        dto.setAcres(f.getAcres());
        dto.setExpectedYield(f.getExpectedYield());
        dto.setSoil_type(f.getSoil_type());
        dto.setAadhar(f.getAadhar());
        dto.setStatus(f.getStatus());
        dto.setBlock(user.isBlocked());
        return dto;
    }

    public void approveFarmer(Long id) {
        Farmer f = farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));

        f.setStatus("APPROVED");
        farmerRepo.save(f);
    }

    public void rejectFarmer(Long id) {
        Farmer f = farmerRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("Farmer not found"));

        f.setStatus("REJECTED");
        farmerRepo.save(f);
    }
    
    public ProfileUpdateDTO getUserByRole(Long id) {

        User user = userRepo.findById(id)
                .orElseThrow(() -> new RuntimeException("User not found"));

        ProfileUpdateDTO dto = new ProfileUpdateDTO();
        dto.setUserId(user.getId());
        dto.setUserName(user.getUsername());
        dto.setRole(user.getRole());

        switch (user.getRole().toUpperCase()) {

            case "FARMER":
                Farmer f = farmerRepo.findById(id)
                        .orElseThrow(() -> new RuntimeException("Farmer not found"));

                dto.setFarmName(f.getFarmName());
                dto.setCropType(f.getCropType());
                dto.setLocation1(f.getLocation());
                dto.setFarmLocation(f.getFarmLocation());
                dto.setMobile(f.getMobile());
                dto.setAcres(f.getAcres());
                dto.setExpectedYield(f.getExpectedYield());
                dto.setSoil_type(f.getSoil_type());
                dto.setAadhar(f.getAadhar());
                dto.setStatus(f.getStatus());
                break;

            case "ADMIN":
                Admin a = adminRepo.findById(id)
                        .orElseThrow(() -> new RuntimeException("Admin not found"));
                dto.setDepartment(a.getDepartment());
                break;

            case "DISTRIBUTOR":
                Distributor d = distributorRepo.findById(id)
                        .orElseThrow(() -> new RuntimeException("Distributor not found"));
                dto.setCompanyName(d.getCompanyName());
                dto.setRegion(d.getRegion());
                break;

            case "RETAILER":
                Retailer r = retailerRepo.findById(id)
                        .orElseThrow(() -> new RuntimeException("Retailer not found"));
                dto.setShopName(r.getShopName());
                dto.setLocation(r.getLocation());
                break;

            default:
                throw new RuntimeException("Invalid role");
        }

        return dto;
    }

}
