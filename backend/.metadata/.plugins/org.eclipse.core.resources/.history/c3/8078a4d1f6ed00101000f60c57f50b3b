package com.farmchainx.backend.service;

import com.farmchainx.backend.dto.AuthResponse;
import com.farmchainx.backend.dto.LoginRequest;
import com.farmchainx.backend.dto.RegisterRequest;
import com.farmchainx.backend.entity.*;
import com.farmchainx.backend.exception.InvalidCredentialsException;
import com.farmchainx.backend.exception.UserNotFoundException;
import com.farmchainx.backend.repository.*;
import com.farmchainx.backend.security.JwtUtil;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class AuthService {

    @Autowired private UserRepository userRepo;
    @Autowired private FarmerRepository farmerRepo;
    @Autowired private DistributorRepository distributorRepo;
    @Autowired private RetailerRepository retailerRepo;
    @Autowired private AdminRepository adminRepo;
    @Autowired private JwtUtil jwtUtil;
    @Autowired private PasswordEncoder passwordEncoder;

    // ================= REGISTER =================
    public String register(RegisterRequest req) {

        if (userRepo.findByUsername(req.getUsername()).isPresent()) {
            throw new RuntimeException("Username already exists");
        }

        User user = new User();
        user.setUsername(req.getUsername());
        user.setPassword(passwordEncoder.encode(req.getPassword()));
        user.setRole(req.getRole());

        user = userRepo.save(user);

        switch (req.getRole().toUpperCase()) {

            case "FARMER":
                Farmer f = new Farmer();
                f.setUserId(user.getId());
                f.setCropType(req.getCropType());
                f.setFarmName(req.getFarmName());
                f.setLocation(req.getLocation());
                f.setFarmLocation(req.getFarmLocation());
                farmerRepo.save(f);
                break;

            case "DISTRIBUTOR":
                Distributor d = new Distributor();
                d.setUserId(user.getId());
                d.setCompanyName(req.getCompanyName());
                d.setRegion(req.getRegion());
                distributorRepo.save(d);
                break;

            case "RETAILER":
                Retailer r = new Retailer();
                r.setUserId(user.getId());
                r.setShopName(req.getShopName());
                r.setLocation(req.getLocation());
                retailerRepo.save(r);
                break;

            case "ADMIN":
                Admin a = new Admin();
                a.setUserId(user.getId());
                a.setDepartment(req.getDepartment());
                adminRepo.save(a);
                break;

            default:
                throw new RuntimeException("Invalid role");
        }

        return "Registration successful";
    }

    // ================= LOGIN =================
    public AuthResponse login(LoginRequest req) {

        User user = userRepo.findByUsername(req.getUsername())
        		.orElseThrow(() ->
        	    new UserNotFoundException("User not registered. Please register first")
        	);

        if (!passwordEncoder.matches(req.getPassword(), user.getPassword())
                || !user.getRole().equalsIgnoreCase(req.getRole())) {
        	throw new InvalidCredentialsException("Invalid credentials");
        }

        String token = jwtUtil.generateToken(user.getUsername(), user.getRole());

        AuthResponse res = new AuthResponse();
        res.setToken(token);
        res.setRole(user.getRole());
        res.setUserId(user.getId());
        return res;
    }
}
